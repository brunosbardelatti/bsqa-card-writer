<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‚öôÔ∏è Configura√ß√µes - BSQA Card Writer</title>
  <style>
    :root {
      --bg-color: #1e1e1e;
      --card-bg: #2a2a2a;
      --accent-color: #ffffff;
      --text-color: #f4f4f4;
      --muted-text: #bbbbbb;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      min-height: 100vh;
    }
    .container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 10px;
      max-width: 800px;
      width: 100%;
    }
    .config-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--muted-text);
    }
    .config-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .config-section h2 {
      color: var(--accent-color);
      margin-bottom: 1rem;
      font-size: 1.4em;
    }
    .config-item {
      margin-bottom: 1rem;
    }
    .config-item label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-color);
      font-weight: 500;
    }
    input[type="text"], input[type="email"], select, textarea {
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--muted-text);
      border-radius: 6px;
      padding: 0.75rem;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .checkbox-item.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .checkbox-item.disabled label {
      cursor: not-allowed;
    }
    .save-btn {
      background: var(--accent-color);
      color: var(--bg-color);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background .3s;
      margin-top: 1rem;
    }
    .save-btn:hover {
      background: var(--muted-text);
    }
    .status-message {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      display: none;
    }
    .status-success {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid #4caf50;
    }
    .status-error {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: 1px solid #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Bot√µes de navega√ß√£o no topo -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <button onclick="window.location.href='index.html'" style="background: var(--accent-color); color: var(--text-color); border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem; width: 200px;">
        ‚Üê Voltar ao QA Card Writer
      </button>
      <button class="save-btn" id="saveBtnTop" onclick="saveConfig()" style="margin: 0; width: 200px;">üíæ Salvar Configura√ß√µes</button>
    </div>
    <h1>‚öôÔ∏è Configura√ß√µes do Usu√°rio</h1>

    <div class="config-section">
      <h2>üë§ Informa√ß√µes Pessoais</h2>
      <div class="config-item">
        <label for="userName">Nome do Usu√°rio <span title="Seu nome completo para identifica√ß√£o nos documentos gerados" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <input type="text" id="userName" placeholder="Seu nome completo">
      </div>
      <div class="config-item">
        <label for="userEmail">Email <span title="Seu email para contato e identifica√ß√£o" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <input type="email" id="userEmail" placeholder="seu@email.com">
      </div>
      <div class="config-item">
        <label for="userCompany">Empresa <span title="Nome da sua empresa para personaliza√ß√£o dos documentos" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <input type="text" id="userCompany" placeholder="Nome da empresa">
      </div>
    </div>

    <div class="config-section">
      <h2>ü§ñ Configura√ß√µes de IA</h2>
      <div class="config-item">
        <label for="defaultAI">IA Padr√£o <span title="Selecione qual IA ser√° usada por padr√£o: OpenAI ou StackSpot AI" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <select id="defaultAI">
          <option value="openai">OpenAI</option>
          <option value="stackspot">StackSpot AI</option>
        </select>
      </div>
      <div class="config-item">
        <label for="maxTokens">M√°ximo de Tokens <span title="N√∫mero m√°ximo de tokens para gerar a resposta. Valores maiores geram respostas mais detalhadas" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <input type="text" id="maxTokens" placeholder="1000" value="1000">
      </div>
      
      <!-- Configura√ß√µes OpenAI -->
      <div class="config-item">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
          <label>üîë Configura√ß√µes OpenAI <span title="Configura√ß√µes necess√°rias para usar a OpenAI" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
          <div style="display: flex; align-items: center;">
            <input type="checkbox" id="openaiEnabled" style="margin-right: 0.5rem;">
            <label for="openaiEnabled" style="margin: 0; font-size: 0.9em;">Habilitar OpenAI</label>
          </div>
        </div>
        <div class="config-item">
          <label for="openaiApiKey">API Key <span title="Sua chave de API da OpenAI (obrigat√≥rio para usar OpenAI)" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
          <input type="password" id="openaiApiKey" placeholder="sk-..." disabled>
        </div>
      </div>
      
      <!-- Configura√ß√µes StackSpot AI -->
      <div class="config-item">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
          <label>üîë Configura√ß√µes StackSpot AI <span title="Configura√ß√µes necess√°rias para usar o StackSpot AI" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
          <div style="display: flex; align-items: center;">
            <input type="checkbox" id="stackspotEnabled" style="margin-right: 0.5rem;">
            <label for="stackspotEnabled" style="margin: 0; font-size: 0.9em;">Habilitar StackSpot AI</label>
          </div>
        </div>
        <div class="config-item">
          <label for="stackspotClientId">Client ID <span title="ID do cliente StackSpot (obrigat√≥rio)" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
          <input type="text" id="stackspotClientId" placeholder="seu-client-id" disabled>
        </div>
        <div class="config-item">
          <label for="stackspotClientSecret">Client Secret <span title="Chave secreta do cliente StackSpot (obrigat√≥rio)" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
          <input type="password" id="stackspotClientSecret" placeholder="seu-client-secret" disabled>
        </div>
        <div class="config-item">
          <label for="stackspotRealm">Realm <span title="Realm do StackSpot (obrigat√≥rio)" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
          <input type="text" id="stackspotRealm" placeholder="seu-realm" disabled>
        </div>
        <div class="config-item">
          <label for="stackspotAgentId">Agent ID <span title="ID do agente StackSpot (obrigat√≥rio)" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
          <input type="text" id="stackspotAgentId" placeholder="seu-agent-id" disabled>
        </div>
      </div>
      
      <div class="config-item">
        <label>Configura√ß√µes StackSpot AI <span title="Configura√ß√µes espec√≠ficas para o StackSpot AI" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <div class="checkbox-item">
          <input type="checkbox" id="streaming">
          <label for="streaming">Streaming (resposta em tempo real) <span title="Ativa o modo streaming para receber respostas em tempo real do StackSpot AI" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="stackspotKnowledge">
          <label for="stackspotKnowledge">Usar conhecimento StackSpot <span title="Utiliza o conhecimento espec√≠fico do StackSpot para melhorar as respostas" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="returnKsInResponse">
          <label for="returnKsInResponse">Retornar KS na resposta <span title="Inclui informa√ß√µes do Knowledge Source (KS) na resposta gerada" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        </div>
      </div>
       
      <!-- Bot√£o para testar configura√ß√µes -->
      <div class="config-item" style="margin-top: 1rem;">
        <button onclick="testApiConfig()" style="background: var(--accent-color); color: var(--bg-color); border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
          üß™ Testar Configura√ß√µes de API
        </button>
        <div id="testResult" style="margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; display: none;"></div>
      </div>
    </div>

    <div class="config-section">
      <h2>üìã Prefer√™ncias de Sa√≠da</h2>
      <div class="checkbox-item">
        <input type="checkbox" id="autoCopy">
        <label for="autoCopy">Copiar resultado automaticamente <span title="Copia automaticamente o resultado para a √°rea de transfer√™ncia ap√≥s a gera√ß√£o" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="clearAfterSuccess" checked>
        <label for="clearAfterSuccess">Limpar campos ap√≥s sucesso <span title="Limpa automaticamente os campos de entrada ap√≥s gerar uma resposta com sucesso" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
      </div>
      <div class="checkbox-item disabled">
        <input type="checkbox" id="showHistory" disabled>
        <label for="showHistory" title="Funcionalidade em desenvolvimento - Em breve dispon√≠vel">Mostrar hist√≥rico de an√°lises <span title="Permite visualizar e reutilizar an√°lises anteriores (funcionalidade em desenvolvimento)" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <span style="color: var(--muted-text); font-size: 0.8em; margin-left: 0.5rem;">(Em desenvolvimento)</span>
      </div>
    </div>

    <div class="config-section">
      <h2>üé® Configura√ß√µes de Interface</h2>
      <div class="config-item">
        <label for="theme">Tema <span title="Escolha entre tema escuro, claro ou autom√°tico baseado nas configura√ß√µes do sistema" style="color: var(--accent-color); cursor: help;">‚ÑπÔ∏è</span></label>
        <select id="theme">
          <option value="dark">Escuro (Padr√£o)</option>
          <option value="light">Claro</option>
          <option value="auto">Autom√°tico</option>
        </select>
      </div>
    </div>

    <!-- Bot√µes de navega√ß√£o no rodap√© -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--muted-text);">
      <button onclick="window.location.href='index.html'" style="background: var(--accent-color); color: var(--text-color); border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem; width: 200px;">
        ‚Üê Voltar ao QA Card Writer
      </button>
      <button class="save-btn" id="saveBtn" onclick="saveConfig()" style="margin: 0; width: 200px;">üíæ Salvar Configura√ß√µes</button>
    </div>
    <div id="statusMessage" class="status-message"></div>
  </div>

  <script>
    // Carregar configura√ß√µes salvas
    async function loadConfig() {
      try {
        // Primeiro tenta carregar do localStorage (cache)
        const localConfig = JSON.parse(localStorage.getItem('bsqaConfig') || '{}');
        
        // Depois busca do servidor (fonte da verdade)
        const response = await fetch('http://localhost:8000/config');
        if (response.ok) {
          const serverConfig = await response.json();
          
          // Mescla configura√ß√µes (servidor tem prioridade)
          const mergedConfig = { ...localConfig, ...serverConfig };
          
          // Aplica valores aos campos
          applyConfigToFields(mergedConfig);
          
          // Atualiza cache local
          localStorage.setItem('bsqaConfig', JSON.stringify(mergedConfig));
        } else {
          // Se servidor n√£o dispon√≠vel, usa cache local
          applyConfigToFields(localConfig);
        }
        
        // Carregar configura√ß√µes de API
        await loadApiConfig();
      } catch (error) {
        console.log('Erro ao carregar configura√ß√µes do servidor, usando cache local:', error);
        const localConfig = JSON.parse(localStorage.getItem('bsqaConfig') || '{}');
        applyConfigToFields(localConfig);
        await loadApiConfig();
      }
    }

    // Carregar configura√ß√µes de API
    async function loadApiConfig() {
      try {
        const response = await fetch('http://localhost:8000/api-config');
        if (response.ok) {
          const apiConfig = await response.json();
          applyApiConfigToFields(apiConfig);
        }
      } catch (error) {
        console.log('Erro ao carregar configura√ß√µes de API:', error);
      }
    }

    // Aplicar configura√ß√µes de API aos campos
    function applyApiConfigToFields(apiConfig) {
      // Configurar OpenAI
      const openaiEnabled = document.getElementById('openaiEnabled');
      const openaiApiKey = document.getElementById('openaiApiKey');
      if (apiConfig.OPENAI_API_KEY) {
        openaiEnabled.checked = true;
        openaiApiKey.value = apiConfig.OPENAI_API_KEY;
        openaiApiKey.disabled = false;
      } else {
        openaiEnabled.checked = false;
        openaiApiKey.disabled = true;
      }
      
      // Configurar StackSpot
      const stackspotEnabled = document.getElementById('stackspotEnabled');
      const stackspotFields = ['stackspotClientId', 'stackspotClientSecret', 'stackspotRealm', 'stackspotAgentId'];
      const hasStackspotConfig = apiConfig.Client_ID_stackspot && apiConfig.Client_Key_stackspot && 
                                apiConfig.Realm_stackspot && apiConfig.STACKSPOT_AGENT_ID;
      
      if (hasStackspotConfig) {
        stackspotEnabled.checked = true;
        if (apiConfig.Client_ID_stackspot) document.getElementById('stackspotClientId').value = apiConfig.Client_ID_stackspot;
        if (apiConfig.Client_Key_stackspot) document.getElementById('stackspotClientSecret').value = apiConfig.Client_Key_stackspot;
        if (apiConfig.Realm_stackspot) document.getElementById('stackspotRealm').value = apiConfig.Realm_stackspot;
        if (apiConfig.STACKSPOT_AGENT_ID) document.getElementById('stackspotAgentId').value = apiConfig.STACKSPOT_AGENT_ID;
        stackspotFields.forEach(fieldId => {
          document.getElementById(fieldId).disabled = false;
        });
      } else {
        stackspotEnabled.checked = false;
        stackspotFields.forEach(fieldId => {
          document.getElementById(fieldId).disabled = true;
        });
      }
    }

    // Aplicar configura√ß√µes aos campos
    function applyConfigToFields(config) {
      if (config.userName) document.getElementById('userName').value = config.userName;
      if (config.userEmail) document.getElementById('userEmail').value = config.userEmail;
      if (config.userCompany) document.getElementById('userCompany').value = config.userCompany;
      if (config.defaultAI) document.getElementById('defaultAI').value = config.defaultAI;
      if (config.maxTokens) document.getElementById('maxTokens').value = config.maxTokens;
      if (config.autoCopy !== undefined) document.getElementById('autoCopy').checked = config.autoCopy;
      else document.getElementById('autoCopy').checked = false; // Default false
      if (config.clearAfterSuccess !== undefined) document.getElementById('clearAfterSuccess').checked = config.clearAfterSuccess;
      // showHistory sempre desabilitado por enquanto
      if (config.theme) {
        document.getElementById('theme').value = config.theme;
        applyTheme(config.theme);
      }
      // Configura√ß√µes StackSpot
      if (config.streaming !== undefined) document.getElementById('streaming').checked = config.streaming;
      else document.getElementById('streaming').checked = false; // Default false
      if (config.stackspotKnowledge !== undefined) document.getElementById('stackspotKnowledge').checked = config.stackspotKnowledge;
      else document.getElementById('stackspotKnowledge').checked = false; // Default false
      if (config.returnKsInResponse !== undefined) document.getElementById('returnKsInResponse').checked = config.returnKsInResponse;
      else document.getElementById('returnKsInResponse').checked = false; // Default false
    }

    // Aplicar tema
    function applyTheme(theme) {
      const root = document.documentElement;
      
      if (theme === 'light') {
        root.style.setProperty('--bg-color', '#ffffff');
        root.style.setProperty('--text-color', '#333333');
        root.style.setProperty('--card-bg', '#f5f5f5');
        root.style.setProperty('--muted-text', '#666666');
        root.style.setProperty('--accent-color', '#2196f3');
        root.style.setProperty('--border-color', '#e0e0e0');
        // Cores espec√≠ficas para tema claro
        root.style.setProperty('--result-bg', '#f8f9fa');
        root.style.setProperty('--result-text', '#333333');
        root.style.setProperty('--modal-bg', 'rgba(0, 0, 0, 0.5)');
        root.style.setProperty('--modal-content-bg', '#ffffff');
        root.style.setProperty('--modal-text', '#333333');
        root.style.setProperty('--code-bg', '#f1f3f4');
        root.style.setProperty('--code-text', '#333333');
      } else if (theme === 'dark') {
        root.style.setProperty('--bg-color', '#1a1a1a');
        root.style.setProperty('--text-color', '#ffffff');
        root.style.setProperty('--card-bg', '#2d2d2d');
        root.style.setProperty('--muted-text', '#cccccc');
        root.style.setProperty('--accent-color', '#4caf50');
        root.style.setProperty('--border-color', '#444444');
        // Cores espec√≠ficas para tema escuro
        root.style.setProperty('--result-bg', '#333333');
        root.style.setProperty('--result-text', '#ffffff');
        root.style.setProperty('--modal-bg', 'rgba(0, 0, 0, 0.8)');
        root.style.setProperty('--modal-content-bg', '#2d2d2d');
        root.style.setProperty('--modal-text', '#ffffff');
        root.style.setProperty('--code-bg', '#1a1a1a');
        root.style.setProperty('--code-text', '#ffffff');
      } else if (theme === 'auto') {
        // Detectar prefer√™ncia do sistema
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
        return;
      }
    }

    // Listener para mudan√ßa de tema
    document.getElementById('theme').addEventListener('change', function() {
      const selectedTheme = this.value;
      applyTheme(selectedTheme);
    });

    // Salvar configura√ß√µes
    async function saveConfig() {
      const saveBtn = document.getElementById('saveBtn');
      const saveBtnTop = document.getElementById('saveBtnTop');
      const originalText = saveBtn.textContent;
      
      try {
        saveBtn.disabled = true;
        saveBtnTop.disabled = true;
        saveBtn.textContent = 'Salvando...';
        saveBtnTop.textContent = 'Salvando...';
        
        const config = {
          userName: document.getElementById('userName').value,
          userEmail: document.getElementById('userEmail').value,
          userCompany: document.getElementById('userCompany').value,
          defaultAI: document.getElementById('defaultAI').value,
          maxTokens: parseInt(document.getElementById('maxTokens').value) || 1000,
          autoCopy: document.getElementById('autoCopy').checked,
          clearAfterSuccess: document.getElementById('clearAfterSuccess').checked,
          theme: document.getElementById('theme').value,
          // Configura√ß√µes StackSpot
          streaming: document.getElementById('streaming').checked,
          stackspotKnowledge: document.getElementById('stackspotKnowledge').checked,
          returnKsInResponse: document.getElementById('returnKsInResponse').checked
        };

        // Configura√ß√µes de API
        const apiConfig = {
          // Salvar apenas APIs habilitadas
          ...(document.getElementById('openaiEnabled').checked && {
            OPENAI_API_KEY: document.getElementById('openaiApiKey').value
          }),
          ...(document.getElementById('stackspotEnabled').checked && {
            Client_ID_stackspot: document.getElementById('stackspotClientId').value,
            Client_Key_stackspot: document.getElementById('stackspotClientSecret').value,
            Realm_stackspot: document.getElementById('stackspotRealm').value,
            STACKSPOT_AGENT_ID: document.getElementById('stackspotAgentId').value
          })
        };

        // Salva no servidor
        const response = await fetch('http://localhost:8000/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(config)
        });

        // Salva configura√ß√µes de API
        const apiResponse = await fetch('http://localhost:8000/api-config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(apiConfig)
        });

        if (response.ok && apiResponse.ok) {
          // Salva tamb√©m no localStorage como cache
          localStorage.setItem('bsqaConfig', JSON.stringify(config));
          
          saveBtn.textContent = 'Salvo! ‚úÖ';
          saveBtnTop.textContent = 'Salvo! ‚úÖ';
          // Manter o estado "Salvo!" por 3 segundos, depois voltar ao normal
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtnTop.textContent = originalText;
            saveBtn.disabled = false;
            saveBtnTop.disabled = false;
          }, 3000);
        } else {
          throw new Error('Erro ao salvar no servidor');
        }
      } catch (error) {
        console.error('Erro ao salvar configura√ß√µes:', error);
        
        // Fallback: salva apenas no localStorage
        localStorage.setItem('bsqaConfig', JSON.stringify(config));
        
        saveBtn.textContent = 'Salvo (local) ‚ö†Ô∏è';
        saveBtnTop.textContent = 'Salvo (local) ‚ö†Ô∏è';
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtnTop.textContent = originalText;
          saveBtn.disabled = false;
          saveBtnTop.disabled = false;
        }, 3000);
      }
    }

    // Carregar configura√ß√µes ao abrir a p√°gina
    document.addEventListener('DOMContentLoaded', loadConfig);
    
    // Controlar switches das APIs
    document.getElementById('openaiEnabled').addEventListener('change', function() {
      const openaiFields = ['openaiApiKey'];
      openaiFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.disabled = !this.checked;
        if (!this.checked) {
          field.value = '';
        }
      });
    });
    
    document.getElementById('stackspotEnabled').addEventListener('change', function() {
      const stackspotFields = ['stackspotClientId', 'stackspotClientSecret', 'stackspotRealm', 'stackspotAgentId'];
      stackspotFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.disabled = !this.checked;
        if (!this.checked) {
          field.value = '';
        }
      });
    });
    
    // Testar configura√ß√µes de API
    async function testApiConfig() {
      const testResult = document.getElementById('testResult');
      testResult.style.display = 'block';
      testResult.innerHTML = 'üîÑ Testando configura√ß√µes...';
      testResult.style.background = 'rgba(255, 193, 7, 0.2)';
      testResult.style.color = '#ffc107';
      testResult.style.border = '1px solid #ffc107';
      
      try {
        // Primeiro salva as configura√ß√µes atuais
        const apiConfig = {
          // Salvar apenas APIs habilitadas
          ...(document.getElementById('openaiEnabled').checked && {
            OPENAI_API_KEY: document.getElementById('openaiApiKey').value
          }),
          ...(document.getElementById('stackspotEnabled').checked && {
            Client_ID_stackspot: document.getElementById('stackspotClientId').value,
            Client_Key_stackspot: document.getElementById('stackspotClientSecret').value,
            Realm_stackspot: document.getElementById('stackspotRealm').value,
            STACKSPOT_AGENT_ID: document.getElementById('stackspotAgentId').value
          })
        };
        
        // Salva no servidor
        const response = await fetch('http://localhost:8000/api-config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(apiConfig)
        });
        
        if (response.ok) {
          // Testa as configura√ß√µes usando o endpoint espec√≠fico
          const testResponse = await fetch('http://localhost:8000/test-api-config', {
            method: 'POST',
          });
          
          if (testResponse.ok) {
            const testData = await testResponse.json();
            if (testData.success) {
              let resultHtml = `‚úÖ ${testData.message}<br><br>`;
              if (testData.results && testData.results.length > 0) {
                resultHtml += '<strong>Detalhes dos testes:</strong><br>';
                testData.results.forEach(result => {
                  const icon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                  const color = result.status === 'success' ? '#4caf50' : '#f44336';
                  resultHtml += `<span style="color: ${color};">${icon} ${result.service}: ${result.message}</span><br>`;
                });
              }
              testResult.innerHTML = resultHtml;
              testResult.style.background = 'rgba(76, 175, 80, 0.2)';
              testResult.style.color = '#4caf50';
              testResult.style.border = '1px solid #4caf50';
            } else {
              let resultHtml = `‚ùå ${testData.message}<br><br>`;
              if (testData.results && testData.results.length > 0) {
                resultHtml += '<strong>Detalhes dos testes:</strong><br>';
                testData.results.forEach(result => {
                  const icon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                  const color = result.status === 'success' ? '#4caf50' : '#f44336';
                  resultHtml += `<span style="color: ${color};">${icon} ${result.service}: ${result.message}</span><br>`;
                });
              }
              testResult.innerHTML = resultHtml;
              testResult.style.background = 'rgba(244, 67, 54, 0.2)';
              testResult.style.color = '#f44336';
              testResult.style.border = '1px solid #f44336';
            }
          } else {
            const errorData = await testResponse.json();
            testResult.innerHTML = `‚ùå Erro ao testar configura√ß√µes: ${errorData.detail}`;
            testResult.style.background = 'rgba(244, 67, 54, 0.2)';
            testResult.style.color = '#f44336';
            testResult.style.border = '1px solid #f44336';
          }
        } else {
          testResult.innerHTML = '‚ùå Erro ao salvar configura√ß√µes de API';
          testResult.style.background = 'rgba(244, 67, 54, 0.2)';
          testResult.style.color = '#f44336';
          testResult.style.border = '1px solid #f44336';
        }
      } catch (error) {
        console.error('Erro ao testar configura√ß√µes:', error);
        testResult.innerHTML = `‚ùå Erro ao testar configura√ß√µes: ${error.message}`;
        testResult.style.background = 'rgba(244, 67, 54, 0.2)';
        testResult.style.color = '#f44336';
        testResult.style.border = '1px solid #f44336';
      }
    }
  </script>
</body>
</html> 