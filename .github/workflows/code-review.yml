name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Gerando Diff
        run: |
          echo "üìä Gerando diff do PR..."
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt

          if [ ! -f diff.txt ] || [ ! -s diff.txt ]; then
            echo "‚ö†Ô∏è Diff vazio - criando diff padr√£o"
            echo "No changes to review" > diff.txt
          fi

          DIFF_SIZE=$(wc -c < diff.txt)
          echo "üìè Tamanho do diff: $DIFF_SIZE bytes"
          
          if [ $DIFF_SIZE -gt 51200 ]; then
            echo "‚úÇÔ∏è Truncando diff (muito grande)..."
            head -c 51200 diff.txt > diff_truncated.txt
            echo -e "\n\n... [DIFF TRUNCADO - MUITAS ALTERA√á√ïES] ..." >> diff_truncated.txt
            mv diff_truncated.txt diff.txt
          fi

      - name: üìù Baixando Prompt do Google Drive
        run: |
          echo "üì• Baixando prompt template do Google Drive..."
          
                     # FILE_ID do Google Drive
           FILE_ID="1W2CQkS9WMJ2z1kvDdOh-R51syvhBSshO"
          
          # Estrat√©gia 1: Download direto com User-Agent e follow redirects
          echo "üîÑ Tentativa 1: Download direto..."
          if curl -L -s --fail --max-time 30 \
            -H "User-Agent: Mozilla/5.0 (Linux; x86_64) AppleWebKit/537.36" \
            "https://drive.google.com/uc?export=download&id=$FILE_ID" \
            -o prompt_template.txt; then
            
            if [ -s prompt_template.txt ] && ! grep -q "<!DOCTYPE html>" prompt_template.txt; then
              echo "‚úÖ Prompt baixado com sucesso (Estrat√©gia 1)"
              echo "üìä Tamanho: $(wc -c < prompt_template.txt) bytes"
              echo "üìã Preview do prompt:"
              head -n 5 prompt_template.txt
            else
              echo "‚ö†Ô∏è Estrat√©gia 1 retornou HTML, tentando estrat√©gia 2..."
              
              # Estrat√©gia 2: Usar wget
              echo "üîÑ Tentativa 2: Usando wget..."
              if wget -q --timeout=30 --max-redirect=10 \
                --user-agent="Mozilla/5.0 (Linux; x86_64) AppleWebKit/537.36" \
                "https://drive.google.com/uc?export=download&id=$FILE_ID" \
                -O prompt_template.txt; then
                
                if [ -s prompt_template.txt ] && ! grep -q "<!DOCTYPE html>" prompt_template.txt; then
                  echo "‚úÖ Prompt baixado com sucesso (Estrat√©gia 2)"
                  echo "üìä Tamanho: $(wc -c < prompt_template.txt) bytes"
                  echo "üìã Preview do prompt:"
                  head -n 5 prompt_template.txt
                else
                  echo "‚ö†Ô∏è Estrat√©gia 2 tamb√©m falhou, usando fallback..."
                  
                  # Estrat√©gia 3: Fallback - criar prompt b√°sico
                  echo "üîÑ Estrat√©gia 3: Usando prompt local como fallback..."
                  if [ -f "config/prompts/prompt_template_code_review_diff.txt" ]; then
                    cp "config/prompts/prompt_template_code_review_diff.txt" prompt_template.txt
                    echo "‚úÖ Usando prompt local como fallback"
                    echo "üìä Tamanho: $(wc -c < prompt_template.txt) bytes"
                  else
                    echo "‚ùå Nem Google Drive nem arquivo local dispon√≠vel"
                    echo "üîç Debug - Conte√∫do baixado do Google Drive:"
                    head -n 10 prompt_template.txt
                    exit 1
                  fi
                fi
              else
                echo "‚ùå Wget tamb√©m falhou"
                exit 1
              fi
            fi
          else
            echo "‚ùå Falha no curl inicial"
            exit 1
          fi

      - name: üõ†Ô∏è Preparando Prompt Final
        run: |
          echo "üîß Montando prompt final com diff..."
          
          # Concatenar prompt + diff de forma simples (sem substitui√ß√µes complexas)
          {
            cat prompt_template.txt
            echo ""
            echo ""
            cat diff.txt
          } > prompt.txt
          
          echo "‚úÖ Prompt final preparado"
          echo "üìä Tamanho final: $(wc -c < prompt.txt) bytes"

      - name: üîê Autentica√ß√£o StackSpot
        run: |
          echo "üîê Obtendo token StackSpot..."
          
          TOKEN_RESPONSE=$(curl -s --fail --max-time 30 \
            --location 'https://idm.stackspot.com/stackspot-freemium/oidc/oauth/token' \
            --header 'Content-Type: application/x-www-form-urlencoded' \
            --data-urlencode "client_id=${{ secrets.STACKSPOT_CLIENT_ID }}" \
            --data-urlencode 'grant_type=client_credentials' \
            --data-urlencode "client_secret=${{ secrets.STACKSPOT_CLIENT_SECRET }}") || {
            echo "‚ùå Falha na autentica√ß√£o StackSpot"
            exit 1
          }
          
          if ! echo "$TOKEN_RESPONSE" | jq . > /dev/null 2>&1; then
            echo "‚ùå Resposta de autentica√ß√£o inv√°lida"
            exit 1
          fi
          
          if echo "$TOKEN_RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$TOKEN_RESPONSE" | jq -r '.error_description // .error')
            echo "‚ùå Erro de autentica√ß√£o: $ERROR"
            exit 1
          fi
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "‚ùå Token n√£o encontrado na resposta"
            exit 1
          fi
          
          echo "::add-mask::$ACCESS_TOKEN"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
          echo "‚úÖ Autentica√ß√£o bem-sucedida"

      - name: ü§ñ An√°lise com StackSpot AI
        run: |
          echo "üöÄ Enviando para an√°lise da IA..."
          
          PROMPT_CONTENT=$(cat prompt.txt)
          ESCAPED_PROMPT=$(printf '%s' "$PROMPT_CONTENT" | jq -Rs .)
          
          RESPONSE=$(curl -s -w "\n###STATUS###%{http_code}" \
            --max-time 60 \
            --location "https://genai-inference-app.stackspot.com/v1/agent/${{ secrets.STACKSPOT_AGENT_ID }}/chat" \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer $ACCESS_TOKEN" \
            --data "{
              \"streaming\": false,
              \"user_prompt\": $ESCAPED_PROMPT,
              \"stackspot_knowledge\": false,
              \"return_ks_in_response\": false
            }")
          
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n 1 | sed 's/.*###STATUS###//')
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå Erro na API StackSpot (HTTP $HTTP_STATUS)"
            exit 1
          fi
          
          if ! echo "$RESPONSE_BODY" | jq . > /dev/null 2>&1; then
            echo "‚ùå Resposta da IA inv√°lida"
            exit 1
          fi
          
          REVIEW_OUTPUT=$(echo "$RESPONSE_BODY" | jq -r '.message // .output_text // empty')
          
          if [ -z "$REVIEW_OUTPUT" ] || [ "$REVIEW_OUTPUT" = "null" ]; then
            echo "‚ùå Falha ao extrair resposta da IA"
            exit 1
          fi
          
          echo "$REVIEW_OUTPUT" > review.txt
          echo "‚úÖ An√°lise conclu√≠da"
          
          echo "üìã Conte√∫do da an√°lise recebida:"
          echo "============================================"
          cat review.txt
          echo "============================================"

      - name: üí¨ Coment√°rio no PR
        run: |
          echo "üí¨ Adicionando coment√°rio ao PR..."
          
          {
            echo "## ü§ñ Revis√£o Autom√°tica de C√≥digo - StackSpot AI"
            echo ""
            echo "**PR:** #${{ github.event.pull_request.number }}"
            echo "**Branch:** \`${{ github.head_ref }}\` ‚Üí \`${{ github.base_ref }}\`"
            echo "**Prompt Source:** Google Drive"
            echo ""
            echo "---"
            echo ""
            cat review.txt
            echo ""
            echo "---"
            echo "*Gerado em $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
          } > final_review.txt
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file final_review.txt
          echo "‚úÖ Coment√°rio adicionado com sucesso"

      - name: ‚ö° Valida√ß√£o do Resultado
        run: |
          echo "üîç Validando resultado..."
          
          if grep -q "REPROVADO" review.txt; then
            echo "‚ùå REPROVADO - Problemas cr√≠ticos encontrados"
            exit 1
          elif grep -q "APROVADO" review.txt; then
            echo "‚úÖ APROVADO - C√≥digo pode prosseguir"
          else
            echo "‚ö†Ô∏è INDETERMINADO - Assumindo aprova√ß√£o"
          fi

      - name: üßπ Limpeza
        if: always()
        run: |
          rm -f diff.txt prompt_template.txt prompt.txt review.txt final_review.txt
          echo "‚úÖ Arquivos tempor√°rios removidos"