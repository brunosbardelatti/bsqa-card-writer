name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          echo "üì¶ Instalando depend√™ncias necess√°rias..."
          
          # Instalar jq se n√£o estiver dispon√≠vel
          if ! command -v jq &> /dev/null; then
            echo "Instalando jq..."
            sudo apt update
            sudo apt install -y jq
          else
            echo "‚úÖ jq j√° est√° instalado"
          fi
          
          # Instalar gh CLI se n√£o estiver dispon√≠vel
          if ! command -v gh &> /dev/null; then
            echo "Instalando GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install -y gh
          else
            echo "‚úÖ GitHub CLI j√° est√° instalado"
          fi
          
          echo "‚úÖ Todas as depend√™ncias foram verificadas"

      - name: Get Pull Request Diff
        run: |
          echo "Fetching base branch..."
          git fetch origin ${{ github.base_ref }}
          
          echo "Generating diff..."
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt
          
          if [ ! -f diff.txt ] || [ ! -s diff.txt ]; then
            echo "‚ùå Erro: N√£o foi poss√≠vel gerar o diff ou o diff est√° vazio"
            echo "No changes to review" > diff.txt
          fi
          
          # Limitar tamanho do diff (m√°ximo 50KB)
          DIFF_SIZE=$(wc -c < diff.txt)
          if [ $DIFF_SIZE -gt 51200 ]; then
            echo "‚ö†Ô∏è Diff muito grande ($DIFF_SIZE bytes), truncando..."
            head -c 51200 diff.txt > diff_truncated.txt
            echo -e "\n\n... [DIFF TRUNCADO - MUITAS ALTERA√á√ïES] ..." >> diff_truncated.txt
            mv diff_truncated.txt diff.txt
          fi
          
          echo "=== DIFF FILE PREVIEW ==="
          head -n 20 diff.txt

      - name: Authenticate with StackSpot
        run: |
          echo "üîê Autenticando com StackSpot..."
          
          TOKEN_RESPONSE=$(curl -s --location 'https://idm.stackspot.com/stackspot-freemium/oidc/oauth/token' \
            --header 'Content-Type: application/x-www-form-urlencoded' \
            --data-urlencode "client_id=${{ secrets.STACKSPOT_CLIENT_ID }}" \
            --data-urlencode 'grant_type=client_credentials' \
            --data-urlencode "client_secret=${{ secrets.STACKSPOT_CLIENT_SECRET }}")
          
          if echo "$TOKEN_RESPONSE" | jq -e '.access_token' > /dev/null 2>&1; then
            ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
            echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
            echo "‚úÖ Autentica√ß√£o bem-sucedida"
          else
            echo "‚ùå Erro: Token de acesso n√£o encontrado na resposta"
            echo "Response: $TOKEN_RESPONSE"
            exit 1
          fi

      - name: Call StackSpot AI for Code Review
        run: |
          echo "ü§ñ Chamando StackSpot AI para revis√£o..."
          
          # Criar arquivo tempor√°rio com o prompt
          {
            echo "You are a senior code reviewer."
            echo
            echo "You will receive a raw Git diff via {requirements}."
            echo "This diff compares a feature branch to the homolog branch."
            echo
            echo "**Your task:**"
            echo
            echo "1. Analyze the diff and automatically detect the programming language or framework (e.g., Python, Robot Framework, Node.js, PHP)."
            echo "   - Apply **best practices, linting rules, and conventions** specific to the detected technology."
            echo
            echo "2. Provide a **code review in Portuguese (Brazil)** with the following structure:"
            echo "   - **Feedback por Arquivo**: List only the files where there are **problems, issues, or relevant improvement points**."
            echo "     - Show **only the problematic snippets** using code blocks (\`\`\`), explaining **what is wrong or can be improved**."
            echo "     - Provide **objective correction/refactoring suggestions**."
            echo "     - **Explain the practical impact of each issue or suggestion** (e.g., \"isso pode causar falhas intermitentes nos testes\")."
            echo "     - Include **Opini√µes** only when they are optional adjustments that improve clarity, performance, or standardization."
            echo
            echo "3. **Classifica√ß√£o de Achados**"
            echo "   - **Cr√≠ticos** ‚Äì Bugs, logical errors, or security vulnerabilities."
            echo "   - **Melhorias** ‚Äì Refactorings, best practices, performance, linting."
            echo "   - **Opini√µes** ‚Äì Optional style or clarity improvements."
            echo
            echo "4. **Resumo Final**"
            echo "   - Return **APROVADO** if no critical issues are found."
            echo "   - Return **REPROVADO** if critical issues are detected."
            echo "   - List only the relevant action points."
            echo
            echo "---"
            echo
            echo "**Important Rules:**"
            echo "- Do not describe correct or trivial changes."
            echo "- Provide only **useful technical feedback** (critical issues or real improvements)."
            echo "- Always explain the practical impact of problems or improvements."
            echo "- Do not include the technology detection section in the response."
            echo "- Use markdown (\`\`\`) to show code snippets when necessary."
            echo "- If there are no issues, finish with a brief positive summary and **APROVADO**."
            echo "- If there are problems, finish with a brief summary and **REPROVADO**."
            echo
            echo "<DIFF_START>"
            cat diff.txt
            echo "<DIFF_END>"
          } > prompt.txt
          
          PROMPT_CONTENT=$(cat prompt.txt)
          
          # Enviar para a API da StackSpot
          RESPONSE=$(curl -s --location 'https://genai-inference-app.stackspot.com/v1/agent/01JZ4135ZCD42NN04PRGA4XA1C/chat' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer $ACCESS_TOKEN" \
            --data "$(jq -n --arg prompt "$PROMPT_CONTENT" '{
              "streaming": false,
              "user_prompt": $prompt,
              "stackspot_knowledge": false,
              "return_ks_in_response": false
            }')")

          if echo "$RESPONSE" | jq -e '.output_text' > /dev/null 2>&1; then
            echo "$RESPONSE" | jq -r '.output_text' > review.txt
            echo "‚úÖ Revis√£o gerada com sucesso"
          else
            echo "‚ö†Ô∏è Falha na an√°lise de c√≥digo por IA - verifique manualmente" > review.txt
          fi

          echo "=== AI REVIEW OUTPUT ==="
          cat review.txt

      - name: Add AI Review as PR Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Adicionando coment√°rio ao PR..."
          
          echo "## ü§ñ Revis√£o Autom√°tica de C√≥digo - StackSpot AI" > final_review.txt
          echo "" >> final_review.txt
          echo "**PR:** #${{ github.event.pull_request.number }}" >> final_review.txt
          echo "**Branch:** \`${{ github.head_ref }}\` ‚Üí \`${{ github.base_ref }}\`" >> final_review.txt
          echo "**Commit:** ${{ github.event.pull_request.head.sha }}" >> final_review.txt
          echo "" >> final_review.txt
          echo "---" >> final_review.txt
          echo "" >> final_review.txt
          cat review.txt >> final_review.txt
          echo "" >> final_review.txt
          echo "---" >> final_review.txt
          echo "*Revis√£o gerada automaticamente em $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> final_review.txt
          
          gh pr comment ${{ github.event.pull_request.number }} --body-file final_review.txt || {
            echo "‚ùå Erro ao adicionar coment√°rio"
            cat final_review.txt
            exit 1
          }

      - name: Cleanup
        if: always()
        run: |
          rm -f diff.txt prompt.txt review.txt final_review.txt
          echo "üßπ Limpeza conclu√≠da"
