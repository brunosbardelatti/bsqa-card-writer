name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          echo "üì¶ Instalando depend√™ncias necess√°rias..."
          
          # Instalar jq se n√£o estiver dispon√≠vel
          if ! command -v jq &> /dev/null; then
            echo "Instalando jq..."
            sudo apt update
            sudo apt install -y jq
          else
            echo "‚úÖ jq j√° est√° instalado"
          fi
          
          # Instalar gh CLI se n√£o estiver dispon√≠vel
          if ! command -v gh &> /dev/null; then
            echo "Instalando GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install -y gh
          else
            echo "‚úÖ GitHub CLI j√° est√° instalado"
          fi
          
          echo "‚úÖ Todas as depend√™ncias foram verificadas"

      - name: Get Pull Request Diff
        run: |
          echo "Fetching base branch..."
          git fetch origin ${{ github.base_ref }}
          
          echo "Generating diff..."
          git diff origin/${{ github.base_ref }}...HEAD > diff.txt
          
          # Verificar se o diff foi gerado
          if [ ! -f diff.txt ] || [ ! -s diff.txt ]; then
            echo "‚ùå Erro: N√£o foi poss√≠vel gerar o diff ou o diff est√° vazio"
            echo "No changes to review" > diff.txt
          fi
          
          # Limitar tamanho do diff (m√°ximo 50KB para evitar problemas com API)
          if [ -f diff.txt ]; then
            DIFF_SIZE=$(wc -c < diff.txt)
            if [ $DIFF_SIZE -gt 51200 ]; then
              echo "‚ö†Ô∏è Diff muito grande ($DIFF_SIZE bytes), truncando..."
              head -c 51200 diff.txt > diff_truncated.txt
              echo -e "\n\n... [DIFF TRUNCADO - MUITAS ALTERA√á√ïES] ..." >> diff_truncated.txt
              mv diff_truncated.txt diff.txt
            fi
          fi
          
          echo "=== DIFF FILE PREVIEW ==="
          head -n 20 diff.txt

      - name: Authenticate with StackSpot
        run: |
          echo "üîê Autenticando com StackSpot..."
          
          TOKEN_RESPONSE=$(curl -s --location 'https://idm.stackspot.com/stackspot-freemium/oidc/oauth/token' \
            --header 'Content-Type: application/x-www-form-urlencoded' \
            --data-urlencode "client_id=${{ secrets.STACKSPOT_CLIENT_ID }}" \
            --data-urlencode 'grant_type=client_credentials' \
            --data-urlencode "client_secret=${{ secrets.STACKSPOT_CLIENT_SECRET }}")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Erro na requisi√ß√£o de autentica√ß√£o"
            exit 1
          fi
          
          # Verificar se a resposta cont√©m token
          if echo "$TOKEN_RESPONSE" | jq -e '.access_token' > /dev/null 2>&1; then
            ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
            echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
            echo "‚úÖ Autentica√ß√£o bem-sucedida"
          else
            echo "‚ùå Erro: Token de acesso n√£o encontrado na resposta"
            echo "Response: $TOKEN_RESPONSE"
            exit 1
          fi

      - name: Create review prompt
        run: |
          echo "üìù Criando prompt para revis√£o..."
          
          # Criar primeira parte do prompt
          cat > prompt_start.txt << 'PROMPT_START'
You are a senior code reviewer.

You will receive a raw Git diff via the placeholder below.
This diff compares a feature branch to the homolog branch.

<DIFF_START>
PROMPT_START
          
          # Criar segunda parte do prompt
          cat > prompt_end.txt << 'PROMPT_END'
<DIFF_END>

**Your task:**

1. Analyze the diff and automatically detect the programming language or framework.
2. Provide a code review in Portuguese (Brazil), highlighting only real issues or improvement points.
3. Classify findings as Cr√≠ticos, Melhorias, or Opini√µes.
4. Finish with APROVADO or REPROVADO.
5. If no significant changes or only minor formatting changes, respond with "‚úÖ APROVADO - Nenhuma altera√ß√£o significativa detectada."
PROMPT_END
          
          # Combinar as partes com o diff
          cat prompt_start.txt > full_prompt.txt
          cat diff.txt >> full_prompt.txt
          cat prompt_end.txt >> full_prompt.txt
          
          echo "‚úÖ Prompt criado com sucesso"

      - name: Call StackSpot AI for Code Review
        run: |
          echo "ü§ñ Chamando StackSpot AI para revis√£o..."
          
          # Ler o prompt completo
          PROMPT_CONTENT=$(cat full_prompt.txt)
          
          # Criar JSON payload usando jq para escape adequado
          RESPONSE=$(curl -s --location 'https://genai-inference-app.stackspot.com/v1/agent/01JZ4135ZCD42NN04PRGA4XA1C/chat' \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer $ACCESS_TOKEN" \
            --data "$(jq -n --arg prompt "$PROMPT_CONTENT" '{
              "streaming": false,
              "user_prompt": $prompt,
              "stackspot_knowledge": false,
              "return_ks_in_response": false
            }')")
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Erro na requisi√ß√£o para StackSpot AI"
            exit 1
          fi
          
          # Verificar se a resposta cont√©m output_text
          if echo "$RESPONSE" | jq -e '.output_text' > /dev/null 2>&1; then
            echo "$RESPONSE" | jq -r '.output_text' > review.txt
            echo "‚úÖ Revis√£o gerada com sucesso"
          else
            echo "‚ùå Erro: output_text n√£o encontrado na resposta"
            echo "Response: $RESPONSE"
            echo "‚ö†Ô∏è Falha na an√°lise de c√≥digo por IA - verifique manualmente" > review.txt
          fi
          
          # Verificar se a revis√£o n√£o est√° vazia ou cont√©m apenas espa√ßos
          if [ ! -s review.txt ] || [ "$(tr -d '[:space:]' < review.txt)" = "" ]; then
            echo "‚ö†Ô∏è Revis√£o vazia detectada, gerando fallback..."
            cat > review.txt << 'FALLBACK_REVIEW'
## ‚ö†Ô∏è Revis√£o Autom√°tica Indispon√≠vel

A an√°lise autom√°tica de c√≥digo n√£o p√¥de ser conclu√≠da devido a problemas t√©cnicos.

**Recomenda√ß√µes:**
- Solicite uma revis√£o manual do c√≥digo
- Verifique se as altera√ß√µes seguem os padr√µes do projeto
- Execute os testes localmente antes do merge

**Status:** üîç **REQUER REVIS√ÉO MANUAL**
FALLBACK_REVIEW
          else
            # Verificar se a revis√£o cont√©m conte√∫do √∫til (mais de 10 caracteres significativos)
            REVIEW_CONTENT=$(tr -d '[:space:]' < review.txt)
            if [ ${#REVIEW_CONTENT} -lt 10 ]; then
              echo "‚ö†Ô∏è Revis√£o muito curta detectada, gerando fallback aprimorado..."
              ORIGINAL_CONTENT=$(cat review.txt | tr '\n' ' ' | cut -c 1-100)
              cat > review.txt << FALLBACK_ENHANCED
## ‚ö†Ô∏è Revis√£o Autom√°tica Limitada

A an√°lise autom√°tica retornou uma resposta muito breve ou inconclusiva.

**Resposta original da IA:** \`$ORIGINAL_CONTENT...\`

**Recomenda√ß√µes:**
- Solicite uma revis√£o manual detalhada do c√≥digo
- Verifique se as altera√ß√µes seguem os padr√µes do projeto
- Execute os testes localmente antes do merge
- Considere fazer altera√ß√µes menores para facilitar a revis√£o

**Status:** üîç **REQUER REVIS√ÉO MANUAL DETALHADA**
FALLBACK_ENHANCED
            fi
          fi
          
          echo "=== AI REVIEW OUTPUT ==="
          cat review.txt

      - name: Add AI Review as PR Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üí¨ Preparando coment√°rio para o PR..."
          
          # Verifica√ß√µes finais antes de postar
          if [ ! -f review.txt ]; then
            echo "‚ùå Erro: Arquivo de revis√£o n√£o encontrado"
            exit 1
          fi
          
          if [ ! -s review.txt ]; then
            echo "‚ùå Erro: Arquivo de revis√£o est√° vazio"
            exit 1
          fi
          
          # Verificar se diff.txt existe e tem conte√∫do para contexto
          DIFF_INFO=""
          if [ -f diff.txt ] && [ -s diff.txt ]; then
            DIFF_SIZE=$(wc -c < diff.txt)
            DIFF_LINES=$(wc -l < diff.txt)
            DIFF_INFO="**Tamanho do diff:** $DIFF_SIZE bytes ($DIFF_LINES linhas)"
          else
            DIFF_INFO="**Diff:** Nenhuma altera√ß√£o detectada"
          fi
          
          # Criar coment√°rio final
          cat > final_review.txt << COMMENT_HEADER
## ü§ñ Revis√£o Autom√°tica de C√≥digo - StackSpot AI

**PR:** #${{ github.event.pull_request.number }}
**Branch:** \`${{ github.head_ref }}\` ‚Üí \`${{ github.base_ref }}\`
**Commit:** ${{ github.event.pull_request.head.sha }}
$DIFF_INFO

---

COMMENT_HEADER
          
          # Adicionar conte√∫do da revis√£o
          cat review.txt >> final_review.txt
          
          # Adicionar rodap√©
          cat >> final_review.txt << COMMENT_FOOTER

---
*Revis√£o gerada automaticamente em $(date -u '+%Y-%m-%d %H:%M:%S UTC')*

<details>
<summary>‚ÑπÔ∏è Informa√ß√µes do Workflow</summary>

- **Workflow:** \`${{ github.workflow }}\`
- **Run ID:** [\`${{ github.run_id }}\`](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
- **Triggered by:** ${{ github.actor }}

</details>
COMMENT_FOOTER
          
          # Postar coment√°rio
          echo "Postando coment√°rio no PR #${{ github.event.pull_request.number }}..."
          if gh pr comment ${{ github.event.pull_request.number }} --body-file final_review.txt; then
            echo "‚úÖ Coment√°rio adicionado com sucesso ao PR #${{ github.event.pull_request.number }}"
          else
            echo "‚ùå Erro ao adicionar coment√°rio ao PR"
            echo "Conte√∫do do coment√°rio:"
            cat final_review.txt
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          # Limpar arquivos tempor√°rios
          rm -f diff.txt prompt_start.txt prompt_end.txt full_prompt.txt review.txt final_review.txt
          echo "üßπ Limpeza conclu√≠da"